---
title: "CVD Prevent Data Visualization"
execute: 
  warning: false
format:
  html: 
    code-fold: true
    fig-width: 10
    fig-height: 5
    toc: true
    toc-location: left
    toc-expand: false
    number-sections: true
    number-depth: 4
---

## Indicator 1

### Percentage of patients aged 18 and over, with GP recorded hypertension, in whom the last blood pressure reading (measured in the preceding 12 months) is below the age appropriate treatment threshold.

This indicator relates to the percentage of patients aged 18 and over who have a recorded hypertension diagnosis by a GP. For these patients, their most recent blood pressure reading (measured in the preceding 12 months) is below the age-appropriate treatment threshold.

This can illustrate the proportion of adult patients diagnosed with hypertension whose most recent blood pressure measurement falls within the desired range for their age, i.e., their hypertension is effectively managed for their age group.

#### Breakdown by Sex

```{r}
#| label: load-packages
#| warning: false
#| echo: false

library(odbc)
library(DBI)
library(glue)
library(dplyr)
library(ggplot2)
library(viridis)
library(hrbrthemes)
library(gridExtra)
library(FunnelPlotR)
```

```{r}
#| echo: false
#| include: false
#| warning: false
read_rds_data <- function(rds_file_name, cols_list) {
  tryCatch({
    message(paste("Reading", rds_file_name, "..."))
    
    loaded_data <- readRDS(rds_file_name)
    
    if (!is.null(cols_list)) {
      colnames(loaded_data) <- cols_list
    }
    
    message("Done! Loaded as a dataframe!")
    return(loaded_data)
  }, error = function(e) {
    message("An unexpected error occurred: ", conditionMessage(e))
  })
}

# Read RDS data

file1 <- "CVDP_ICB_level.rds"
file2 <- "CVDP_LOC_level.rds"

df_ICB <- read_rds_data(rds_file_name = file1, NULL) # ICB level data
df_LOC <- read_rds_data(rds_file_name = file2, NULL) # Locality level data

df_ICB <- df_ICB %>% 
  select(-c("AreaType", "Factor", "ValueNote")) %>% 
  filter_all(all_vars(!is.na(.)))


df_LOC <- df_LOC %>% 
  select(-c("AreaType", "Factor", "ValueNote")) %>% 
  filter_all(all_vars(!is.na(.)))

df <- read.csv("CVD_23_March_CVDP007HYP.csv")
```

```{r}
#| echo: false
#| label: sex-breakdown
#| warning: false


# Histogram
draw_histogram <- function(data, indicator_code, metric_category_type_name, time_period){
  
  df <- data %>% 
    filter(MetricCategoryTypeName == metric_category_type_name,
           IndicatorCode == indicator_code,
           TimePeriodName == time_period)
  
  indicator_name <- unique(df$IndicatorShortName)
  
  plot_title <- glue("{indicator_name} by {metric_category_type_name}")
  
  p <- ggplot(df, aes(x = Value, fill = MetricCategoryName)) +
    geom_histogram(aes(y = ..density..), colour = "black", bins = 30) +
    scale_fill_viridis(discrete = TRUE, alpha = 0.6) +
    geom_density(alpha=.1, fill = "#FF6666") +
    labs(title = plot_title) +
    theme_minimal() +  # Changed to minimal theme to avoid font issues
    theme(axis.title.x = element_blank(),
          text = element_text(size = 12),
          plot.title = element_text(hjust = 0.5, size=12),
          legend.position = "none",
          axis.title=element_text(size=12, face="bold"),
          axis.text = element_text(size = 12)) +
    facet_grid(. ~ MetricCategoryName)
  
  return (p)
}

# Density plot
draw_density_plot <- function(data, indicator_code, metric_category_type_name, specific_area_code, time_period){
  
  df <- data %>%
    filter(MetricCategoryTypeName == metric_category_type_name,
           IndicatorCode == indicator_code,
           TimePeriodName == time_period) %>%
    mutate(SpecificArea = if_else(AreaCode == specific_area_code, "BSOL ICB", "Other ICBs"))
  
  indicator_name <- unique(df$IndicatorShortName)
  
  plot_title <- glue("{indicator_name} by {metric_category_type_name}")
  
  p <- ggplot(df, aes(x = Value, fill = SpecificArea)) +
    geom_density(aes(y = after_stat(density)), alpha=.5, position = "identity") +
    scale_fill_viridis(discrete = TRUE, alpha = 0.6) +
    labs(title = plot_title, 
         y = "Density",
         x = "Percentage Value (%)") +
    theme_minimal() +  # Changed to minimal theme to avoid font issues
    theme(axis.title.x = element_blank(),
          plot.title = element_text(hjust = 0.5, size=12),
          legend.position = "bottom",
          legend.title = element_blank()) +
    facet_grid(. ~ MetricCategoryName)
  
  return (p)
}

# Boxplot
draw_boxplot <- function(data, indicator_code, metric_category_type_name, specific_area_code, time_period) {
  
  df <- data %>%
    filter(MetricCategoryTypeName == metric_category_type_name,
           IndicatorCode == indicator_code,
           TimePeriodName == time_period) %>%
    mutate(SpecificArea = if_else(AreaCode == specific_area_code, "BSOL ICB", "Other ICBs"))
  
  indicator_name <- unique(df$IndicatorShortName)
  
  plot_title <- glue("{indicator_name} by {metric_category_type_name}")
  
  p <- ggplot(df, aes(y = Value, x = MetricCategoryName, fill = SpecificArea)) +
    geom_boxplot(position = position_dodge(width = 0.8), alpha = 0.6) +
    geom_point(color = "black",
               position = position_jitterdodge(jitter.width = 0.4, dodge.width = 0.8), 
               size = 1, 
               alpha = 0.6) +
    scale_fill_viridis(discrete = TRUE, alpha = 0.6) +
    labs(
      title = plot_title,
      y =  "Percentage Value (%)",
      x = "Metric Category" 
    ) +
    theme_minimal() +  # Changed to minimal theme to avoid font issues
    theme(
      text = element_text(size = 12),
      plot.title = element_text(hjust = 0.5, size = 12),
      legend.position = "bottom",
      axis.title.x = element_blank()
    )
  
  return(p)
}

# Example usage (replace df_ICB with your actual data)
# plt1 <- draw_histogram(data = df_ICB, indicator_code = "CVDP007HYP", metric_category_type_name = "Sex", time_period = "To March 2023")
# plt1


```

::: panel-tabset
## Histogram

```{r}
#| fig-cap: "A histogram of Hypertension: treatment to recommended age specific thresholds (all ages) by Sex."

plt1 <- draw_histogram(data = df_ICB, indicator_code = "CVDP007HYP", metric_category_type_name = "Sex", time_period = "To March 2023")

plt1
```

## Density Plot

```{r}
#| fig-cap: "A density plot of Hypertension: treatment to recommended age specific thresholds (all ages) by Sex, compared between BSOL ICB (purple) and the rest of ICBs (yellow)."

plt2 <- draw_density_plot(data = df_ICB , 
             indicator_code = "CVDP007HYP", 
             metric_category_type_name = "Sex", 
             specific_area_code = "E54000055",
             time_period = "To March 2023")

plt2
```

## Boxplot

```{r}
#| fig-cap: "A boxplot of Hypertension: treatment to recommended age specific thresholds (all ages) by Sex, compared between BSOL ICB (purple) and the rest of ICBs (yellow)."
plt2 <- draw_boxplot(data = df_ICB, 
                     indicator_code = "CVDP007HYP", 
                     metric_category_type_name = "Sex", 
                     specific_area_code = "E54000055",
                     time_period = "To March 2023")
plt2
```
:::

A symmetric distribution is observed across all genders. Female patients tend to have a higher proportion of blood pressure readings below the threshold, followed by male patients, and then by the combined category of persons.

#### Breakdown by Age Group

::: panel-tabset
## Histogram

```{r}
#| fig-cap: "A histogram of Hypertension: treatment to recommended age specific thresholds (all ages) by Age Group."

plt1 <- draw_histogram(data = df_ICB, 
                       indicator_code = "CVDP007HYP", 
                       metric_category_type_name = "Age group",
                       time_period = "To March 2023")

plt1
```

## Density Plot

```{r}
#| fig-cap: "A density plot of Hypertension: treatment to recommended age specific thresholds (all ages) by Age Group, compared between BSOL ICB (purple) and the rest of ICBs (yellow)."

plt2 <- draw_density_plot(data = df_ICB, 
             indicator_code = "CVDP007HYP", 
             metric_category_type_name = "Age group", 
             specific_area_code = "E54000055",
             time_period = "To March 2023")

plt2
```

## Boxplot

```{r}
#| fig-cap: "A boxplot of Hypertension: treatment to recommended age specific thresholds (all ages) by Age Group, compared between BSOL ICB (purple) and the rest of ICBs (yellow)."
plt2 <- draw_boxplot(data = df_ICB, 
                     indicator_code = "CVDP007HYP", 
                     metric_category_type_name = "Age group", 
                     specific_area_code = "E54000055",
                     time_period = "To March 2023")
plt2
```
:::

A similar symmetric distribution is evident across different age groups. Notably, older patients, specifically those 80 and above, have a higher proportion of blood pressure readings below the age-appropriate threshold. This could suggest more effective hypertension management in this demographic by healthcare providers. However, some outliers suggest that a small percentage of older patients have blood pressure readings above the threshold, meaning they aren\'t meeting the target.

The trend of meeting the age-appropriate treatment target threshold seems to decline with decreasing age. Younger patients are less likely to meet the target compared to older age groups.

#### Breakdown by Ethnicity

::: panel-tabset
## Histogram

```{r}
#| fig-cap: "A histogram of Hypertension: treatment to recommended age specific thresholds (all ages) by Ethnicity."

plt1 <- draw_histogram(data = df_ICB, 
                       indicator_code = "CVDP007HYP", 
                       metric_category_type_name = "Ethnicity",
                       time_period = "To March 2023") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 12))

plt1

```

## Density Plot

```{r}
#| fig-cap: "A density plot of Hypertension: treatment to recommended age specific thresholds (all ages) by Ethnicity, compared between BSOL ICB (purple) and the rest of ICBs (yellow)."

plt2 <- draw_density_plot(data = df_ICB , 
             indicator_code = "CVDP007HYP", 
             metric_category_type_name = "Ethnicity", 
             specific_area_code = "E54000055",
             time_period = "To March 2023")

plt2
```

## Boxplot

```{r}
#| fig-cap: "A boxplot of Hypertension: treatment to recommended age specific thresholds (all ages) by Ethnicity, compared between BSOL ICB (purple) and the rest of ICBs (yellow)."

plt2 <- draw_boxplot(data = df_ICB, 
                     indicator_code = "CVDP007HYP", 
                     metric_category_type_name = "Ethnicity", 
                     specific_area_code = "E54000055",
                     time_period = "To March 2023")
plt2
```
:::

Patients of white ethnicity have higher proportion of BP values below the threshold i.e., hypertension is under control, followed by Asian ethnicity, and Black having the lowest proportion. Difficult to interpret the inequality across ethnicity due to missing, mixed, and not stated categories.

#### Breakdown by Deprivation Quintile

::: panel-tabset
## Histogram

```{r}
#| fig-cap: "A histogram of Hypertension: treatment to recommended age specific thresholds (all ages) by Deprivation Quintile."
plt1 <- draw_histogram(data = df_ICB, 
                       indicator_code = "CVDP007HYP", 
                       metric_category_type_name = "Deprivation quintile",
                       time_period = "To March 2023")

plt1
```

## Density Plot

```{r}
#| fig-cap: "A density plot of Hypertension: treatment to recommended age specific thresholds (all ages) by Deprivation Quintile, compared between BSOL ICB (purple) and the rest of ICBs (yellow)."
plt2 <- draw_density_plot(data = df_ICB , 
             indicator_code = "CVDP007HYP", 
             metric_category_type_name = "Deprivation quintile", 
             specific_area_code = "E54000055",
             time_period = "To March 2023")

plt2
```

## Boxplot

```{r}
#| fig-cap: "A boxplot of Hypertension: treatment to recommended age specific thresholds (all ages) by Deprivation Quintile, compared between BSOL ICB (purple) and the rest of ICBs (yellow)."
plt2 <- draw_boxplot(data = df_ICB, 
                     indicator_code = "CVDP007HYP", 
                     metric_category_type_name = "Deprivation quintile", 
                     specific_area_code = "E54000055",
                     time_period = "To March 2023")
plt2
```
:::
